---
slug: virtual-threads-guide
title: "ğŸš€ æ·±å…¥ç†è§£ Java è™šæ‹Ÿçº¿ç¨‹ï¼šè½»é‡çº§å¹¶å‘çš„æœªæ¥"
authors: [luqi]
tags: [docusaurus]
---

import CodePlayground from '@site/src/components/CodePlayground';
import Timeline from '@site/src/components/Timeline';
import BrowserOnly from '@docusaurus/BrowserOnly';

<div style={{
  padding: '1rem',
  border: '1px solid #ffd700',
  borderRadius: '4px',
  backgroundColor: '#fffbe6',
  margin: '1rem 0'
}}>
âš ï¸ **é‡è¦æç¤º**ï¼š
1. éœ€è¦Java 19+ç‰ˆæœ¬å¹¶å¯ç”¨é¢„è§ˆç‰¹æ€§
   ```bash
   java --enable-preview -jar your_app.jar
   ```
</div>
import React from 'react';

export const Quote = ({ children }) => (
  <blockquote style={{
    borderLeft: '4px solid #2ecc71',
    padding: '1rem',
    margin: '2rem 0',
    fontStyle: 'italic',
    color: '#555'
  }}>
    {children}
  </blockquote>
);

<Quote>
  "è™šæ‹Ÿçº¿ç¨‹æ˜¯Javaå¹¶å‘æ¨¡å‹çš„é©å‘½æ€§æ”¹è¿›ï¼Œå®ƒä½¿ç¼–å†™ã€è°ƒè¯•å’Œç»´æŠ¤é«˜å¹¶å‘åº”ç”¨å˜å¾—å‰æ‰€æœªæœ‰çš„ç®€å•" 
  <br/> 
  â€” Brian Goetz (Javaè¯­è¨€æ¶æ„å¸ˆ)
</Quote>

## ğŸ“š ä»€ä¹ˆæ˜¯è™šæ‹Ÿçº¿ç¨‹ï¼Ÿ

è™šæ‹Ÿçº¿ç¨‹æ˜¯Javaå¹³å°å¼•å…¥çš„è½»é‡çº§çº¿ç¨‹å®ç°ï¼Œä½œä¸ºProject Loomçš„ä¸€éƒ¨åˆ†ï¼Œæ—¨åœ¨è§£å†³ä¼ ç»Ÿçº¿ç¨‹æ¨¡å‹åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹çš„å±€é™æ€§ã€‚è™šæ‹Ÿçº¿ç¨‹ç”±JVMç®¡ç†ï¼Œè€Œä¸æ˜¯æ“ä½œç³»ç»Ÿï¼Œè¿™ä½¿å¾—åˆ›å»ºå’Œç®¡ç†æˆåƒä¸Šä¸‡ä¸ªçº¿ç¨‹å˜å¾—å¯èƒ½ä¸”é«˜æ•ˆã€‚

<div style={{
  display: 'flex',
  justifyContent: 'center',
  margin: '2rem 0'
}}>
  <div style={{
    padding: '1.5rem',
    backgroundColor: '#f8f9fa',
    borderRadius: '8px',
    maxWidth: '90%',
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
  }}>
    <h3 style={{ margin: '0 0 1rem 0', color: '#333' }}>å¹³å°çº¿ç¨‹ vs è™šæ‹Ÿçº¿ç¨‹</h3>
    <table style={{ width: '100%', borderCollapse: 'collapse' }}>
      <thead>
        <tr>
          <th style={{ padding: '0.5rem', borderBottom: '2px solid #ddd', textAlign: 'left' }}>ç‰¹æ€§</th>
          <th style={{ padding: '0.5rem', borderBottom: '2px solid #ddd', textAlign: 'left' }}>å¹³å°çº¿ç¨‹</th>
          <th style={{ padding: '0.5rem', borderBottom: '2px solid #ddd', textAlign: 'left' }}>è™šæ‹Ÿçº¿ç¨‹</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>å†…å­˜å ç”¨</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>çº¦2MB</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>çº¦1KB</td>
        </tr>
        <tr>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>åˆ›å»ºå¼€é”€</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>é«˜</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>ä½</td>
        </tr>
        <tr>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>ä¸Šä¸‹æ–‡åˆ‡æ¢</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>æ˜‚è´µ</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>è½»é‡</td>
        </tr>
        <tr>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>é€‚ç”¨åœºæ™¯</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>è®¡ç®—å¯†é›†å‹</td>
          <td style={{ padding: '0.5rem', borderBottom: '1px solid #ddd' }}>I/Oå¯†é›†å‹</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

## ğŸ’¡ è™šæ‹Ÿçº¿ç¨‹çš„æ ¸å¿ƒä¼˜åŠ¿

1. **æä½çš„èµ„æºæ¶ˆè€—**ï¼šå¯ä»¥åˆ›å»ºæ•°ç™¾ä¸‡ä¸ªè™šæ‹Ÿçº¿ç¨‹è€Œä¸ä¼šè€—å°½ç³»ç»Ÿèµ„æº
2. **ç®€åŒ–å¹¶å‘æ¨¡å‹**ï¼šä½¿ç”¨åŒæ­¥ç¼–ç¨‹é£æ ¼ç¼–å†™å¼‚æ­¥ä»£ç ï¼Œé¿å…å›è°ƒåœ°ç‹±
3. **å…¼å®¹ç°æœ‰ä»£ç **ï¼šä¸ç°æœ‰çš„Javaçº¿ç¨‹APIå®Œå…¨å…¼å®¹ï¼Œè¿ç§»æˆæœ¬ä½
4. **æé«˜ç³»ç»Ÿååé‡**ï¼šåœ¨I/Oå¯†é›†å‹åº”ç”¨ä¸­æ˜¾è‘—æå‡æ€§èƒ½
5. **é™ä½ç¼–ç¨‹å¤æ‚åº¦**ï¼šæ— éœ€å­¦ä¹ ååº”å¼ç¼–ç¨‹æˆ–å¤æ‚çš„å¼‚æ­¥æ¡†æ¶

## ğŸ§© ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹

åˆ›å»ºå¹¶å¯åŠ¨è™šæ‹Ÿçº¿ç¨‹éå¸¸ç®€å•ï¼š

```java
// åˆ›å»ºå¹¶å¯åŠ¨è™šæ‹Ÿçº¿ç¨‹
Thread vThread = Thread.startVirtualThread(() -> {
    System.out.println("Hello from Virtual Thread!");
});

// ç­‰å¾…è™šæ‹Ÿçº¿ç¨‹å®Œæˆ
vThread.join();
```

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ExecutorServiceåˆ›å»ºè™šæ‹Ÿçº¿ç¨‹ï¼š

```java
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    IntStream.range(0, 10_000).forEach(i -> {
        executor.submit(() -> {
            // æ‰§è¡Œä»»åŠ¡
            Thread.sleep(Duration.ofMillis(100));
            return i;
        });
    });
} // executorè‡ªåŠ¨å…³é—­
```

## ğŸŒ å®é™…åº”ç”¨åœºæ™¯

### WebæœåŠ¡å™¨æ€§èƒ½æå‡

ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¤„ç†HTTPè¯·æ±‚å¯ä»¥æ˜¾è‘—æé«˜WebæœåŠ¡å™¨çš„ååé‡ï¼š

```java
@GetMapping("/data")
public ResponseEntity<String> getData() {
    // æ¯ä¸ªè¯·æ±‚åˆ†é…ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ï¼Œè€Œä¸æ˜¯ä½¿ç”¨çº¿ç¨‹æ± 
    return ResponseEntity.ok("å¤„ç†è¯·æ±‚çš„è™šæ‹Ÿçº¿ç¨‹: " + Thread.currentThread());
}
```

### æ•°æ®åº“æ“ä½œä¼˜åŒ–

è™šæ‹Ÿçº¿ç¨‹ç‰¹åˆ«é€‚åˆæ•°æ®åº“æ“ä½œç­‰I/Oå¯†é›†å‹ä»»åŠ¡ï¼š

```java
// ä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œæ‰¹é‡æ•°æ®åº“æŸ¥è¯¢
List<CompletableFuture<Result>> futures = queries.stream()
    .map(query -> CompletableFuture.supplyAsync(() -> {
        return database.executeQuery(query);
    }, virtualThreadExecutor))
    .toList();

// ç­‰å¾…æ‰€æœ‰æŸ¥è¯¢å®Œæˆ
List<Result> results = futures.stream()
    .map(CompletableFuture::join)
    .toList();
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

<div style={{
  backgroundColor: '#f5f5f5',
  padding: '1.5rem',
  borderRadius: '8px',
  margin: '2rem 0'
}}>
  <h3 style={{ margin: '0 0 1rem 0' }}>ååé‡æµ‹è¯•ï¼šå¹³å°çº¿ç¨‹ vs è™šæ‹Ÿçº¿ç¨‹</h3>
  <div style={{
    height: '200px',
    display: 'flex',
    alignItems: 'flex-end',
    justifyContent: 'space-around',
    padding: '0 2rem'
  }}>
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center'
    }}>
      <div style={{
        width: '100px',
        height: '80px',
        backgroundColor: '#3498db',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        color: 'white',
        fontWeight: 'bold'
      }}>1x</div>
      <div style={{ marginTop: '1rem' }}>å¹³å°çº¿ç¨‹</div>
    </div>
    <div style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center'
    }}>
      <div style={{
        width: '100px',
        height: '180px',
        backgroundColor: '#2ecc71',
        display: 'flex',
        justifyContent: 'center',
        alignItems: 'center',
        color: 'white',
        fontWeight: 'bold'
      }}>2.5x</div>
      <div style={{ marginTop: '1rem' }}>è™šæ‹Ÿçº¿ç¨‹</div>
    </div>
  </div>
  <p style={{ textAlign: 'center', marginTop: '1rem', fontSize: '0.9rem', color: '#666' }}>
    *åŸºäº10,000ä¸ªå¹¶å‘HTTPè¯·æ±‚çš„å¤„ç†æ—¶é—´ï¼Œæ¯ä¸ªè¯·æ±‚åŒ…å«100msçš„I/Oç­‰å¾…
  </p>
</div>

## ğŸš€ æœ€ä½³å®è·µ

1. **é¿å…çº¿ç¨‹å±€éƒ¨å˜é‡**ï¼šè™šæ‹Ÿçº¿ç¨‹åˆ‡æ¢æºå¸¦è€…å¤šä¸ªçº¿ç¨‹å±€éƒ¨å˜é‡ä¼šå¢åŠ å¼€é”€
2. **é€‚ç”¨äºI/Oå¯†é›†å‹ä»»åŠ¡**ï¼šè™šæ‹Ÿçº¿ç¨‹åœ¨I/Oç­‰å¾…æ—¶ä¼šè‡ªåŠ¨è®©å‡ºCPUï¼Œéå¸¸é€‚åˆI/Oå¯†é›†å‹åº”ç”¨
3. **é¿å…åŒæ­¥é˜»å¡**ï¼šå°½ç®¡è™šæ‹Ÿçº¿ç¨‹å¯ä»¥å¤§é‡åˆ›å»ºï¼Œä½†ä»åº”é¿å…ä¸å¿…è¦çš„åŒæ­¥é˜»å¡
4. **ç›‘æ§ä¸è°ƒä¼˜**ï¼šä½¿ç”¨JDK Flight Recorderç›‘æ§è™šæ‹Ÿçº¿ç¨‹çš„æ€§èƒ½
5. **å¹³ç¨³è¿ç§»**ï¼šé€æ­¥å°†ç°æœ‰åº”ç”¨ä»çº¿ç¨‹æ± æ¨¡å¼è¿ç§»åˆ°è™šæ‹Ÿçº¿ç¨‹æ¨¡å¼

## ğŸ” æ€»ç»“

Javaè™šæ‹Ÿçº¿ç¨‹ä»£è¡¨äº†Javaå¹¶å‘ç¼–ç¨‹çš„é‡å¤§è¿›æ­¥ï¼Œé€šè¿‡æä¾›è½»é‡çº§çº¿ç¨‹å®ç°ï¼Œå®ƒä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿç¼–å†™ç®€å•ã€ç›´è§‚ä¸”é«˜æ•ˆçš„å¹¶å‘ä»£ç ã€‚è™šæ‹Ÿçº¿ç¨‹ç‰¹åˆ«é€‚åˆæ„å»ºé«˜ååé‡çš„ç½‘ç»œæœåŠ¡ã€å¾®æœåŠ¡å’Œå…¶ä»–I/Oå¯†é›†å‹åº”ç”¨ã€‚

éšç€Java 21å°†è™šæ‹Ÿçº¿ç¨‹æ­£å¼å‘å¸ƒä¸ºç¨³å®šç‰¹æ€§ï¼Œç°åœ¨æ˜¯æ¢ç´¢å’Œé‡‡ç”¨è¿™ä¸€æŠ€æœ¯çš„æœ€ä½³æ—¶æœºã€‚

<Quote>
  "è™šæ‹Ÿçº¿ç¨‹è®©æˆ‘ä»¬é‡æ–°æ€è€ƒJavaçš„å¹¶å‘æ¨¡å‹ï¼Œå®ƒä¸ä»…æé«˜äº†æ€§èƒ½ï¼Œæ›´é‡è¦çš„æ˜¯ç®€åŒ–äº†ç¼–ç¨‹æ¨¡å‹ï¼Œè®©å¼€å‘è€…å¯ä»¥ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘è€Œéå¹¶å‘æ§åˆ¶ã€‚" 
</Quote>

## ğŸ® äº¤äº’å¼ç¤ºä¾‹

<CodePlayground
  defaultCode={`
    public class VirtualThreadDemo {
        public static void main(String[] args) {
            Thread vThread = Thread.startVirtualThread(() -> {
                System.out.println("Hello from Virtual Thread!");
            });
            
            // å°è¯•ä¿®æ”¹è¿™æ®µä»£ç ï¼
        }
    }
  `}
  height={300}
/>

## â³ è™šæ‹Ÿçº¿ç¨‹å‘å±•å†ç¨‹

<Timeline
  events={[
    {
      date: '2017',
      title: 'Project Loom å¯åŠ¨',
      description: 'Oracleå¯åŠ¨Project Loomé¡¹ç›®ï¼Œæ—¨åœ¨ä¸ºJVMå¸¦æ¥è½»é‡çº§çº¿ç¨‹å®ç°'
    },
    {
      date: '2019',
      title: 'æ—©æœŸåŸå‹',
      description: 'é¦–ä¸ªè™šæ‹Ÿçº¿ç¨‹åŸå‹å‘å¸ƒï¼Œå¼€å‘è€…å¯ä»¥å¼€å§‹å®éªŒ'
    },
    {
      date: '2021',
      title: 'JDK 16é¢„è§ˆ',
      description: 'è™šæ‹Ÿçº¿ç¨‹ä½œä¸ºé¢„è§ˆç‰¹æ€§é¦–æ¬¡åœ¨JDK 16ä¸­äº®ç›¸'
    },
    {
      date: '2023',
      title: 'JDK 21æ­£å¼å‘å¸ƒ',
      description: 'è™šæ‹Ÿçº¿ç¨‹æˆä¸ºæ­£å¼ç‰¹æ€§ï¼Œæ ‡å¿—ç€Javaå¹¶å‘ç¼–ç¨‹çš„æ–°çºªå…ƒ'
    }
  ]}
/>

## ğŸ¯ æ€§èƒ½å¯è§†åŒ–

export const PerformanceChart = () => {
  return (
    <BrowserOnly>
      {() => {
        const {
          BarChart,
          Bar,
          XAxis,
          YAxis,
          CartesianGrid,
          Tooltip,
          Legend
        } = require('recharts');

        const data = [
          {
            name: '1000å¹¶å‘',
            å¹³å°çº¿ç¨‹: 2000,
            è™šæ‹Ÿçº¿ç¨‹: 800,
          },
          {
            name: '5000å¹¶å‘',
            å¹³å°çº¿ç¨‹: 9500,
            è™šæ‹Ÿçº¿ç¨‹: 2300,
          },
          {
            name: '10000å¹¶å‘',
            å¹³å°çº¿ç¨‹: 20000,
            è™šæ‹Ÿçº¿ç¨‹: 4100,
          },
        ];

        return (
          <div style={{ width: '100%', height: 300, marginBottom: '2rem' }}>
            <BarChart
              width={600}
              height={300}
              data={data}
              margin={{
                top: 5,
                right: 30,
                left: 20,
                bottom: 5,
              }}
            >
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="name" />
              <YAxis label={{ value: 'å“åº”æ—¶é—´(ms)', angle: -90, position: 'insideLeft' }} />
              <Tooltip />
              <Legend />
              <Bar dataKey="å¹³å°çº¿ç¨‹" fill="#8884d8" />
              <Bar dataKey="è™šæ‹Ÿçº¿ç¨‹" fill="#82ca9d" />
            </BarChart>
          </div>
        );
      }}
    </BrowserOnly>
  );
};

<PerformanceChart />

## ğŸ¨ è™šæ‹Ÿçº¿ç¨‹å·¥ä½œåŸç†åŠ¨ç”»

<div style={{
  width: '100%',
  height: '400px',
  backgroundColor: '#f8f9fa',
  borderRadius: '8px',
  padding: '1rem',
  position: 'relative',
  overflow: 'hidden'
}}>
  <div className="carrier-thread" style={{
    width: '80%',
    height: '60px',
    backgroundColor: '#3498db',
    margin: '20px auto',
    borderRadius: '4px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    color: 'white',
    fontWeight: 'bold',
    animation: 'pulse 2s infinite'
  }}>
    è½½ä½“çº¿ç¨‹ï¼ˆCarrier Threadï¼‰
  </div>
  
  <div className="virtual-threads" style={{
    display: 'flex',
    justifyContent: 'space-around',
    marginTop: '40px'
  }}>
    {Array(5).fill(0).map((_, i) => (
      <div key={i} style={{
        width: '50px',
        height: '50px',
        backgroundColor: '#2ecc71',
        borderRadius: '50%',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center',
        color: 'white',
        fontSize: '12px',
        animation: `float ${1 + i * 0.2}s infinite alternate`
      }}>
        VT {i+1}
      </div>
    ))}
  </div>
</div>

<style>
{`
  @keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
  }
  
  @keyframes float {
    0% { transform: translateY(0); }
    100% { transform: translateY(-20px); }
  }
`}
</style>


